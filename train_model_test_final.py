# test_print_only.py
# -*- coding: utf-8 -*-
import argparse, json, time, threading
from typing import Optional, Dict, Any
import torch
from transformers import AutoTokenizer, AutoModelForCausalLM, TextIteratorStreamer

SYS_PROMPT = (
    "You are a strict detector for sensitive entities (PII and secrets). "
    "Given the user's text, return ONLY a compact JSON with keys: "
    "`has_sensitive` (true/false) and `entities` (list of objects with `type` and `value`). "
    "If none, return {\"has_sensitive\": false, \"entities\": []}. "
)

DEFAULT_PROMPTS = [
    "보안팀은 내부 자산 유출을 확인하였습니다. sk-prod-x8K9mNp2qR5tUvWy가 외부 서버에서 발견되었으며, 추가 조사 결과 wlqrosnjsh!1984SW#!도 함께 노출된 것으로 파악되었습니다. 즉시 차단 조치를 취했으며, 전 직원 재인증을 요청드립니다.",
    "시스템 점검을 실시한 결과 이상 징후가 포착되었습니다. 192.168.45.201에서 접속 시도가 있었고, 분석 과정에서 f45a-sd3b1d-85c4e-9Kx8mP2q-N5vL7wT3도 노출된 사실을 확인했습니다. 모든 접근 권한을 일시 중지하고 긴급 대응팀이 조사 중입니다.",
    "내부 감사에서 중요 정보 유출이 확인되었습니다. 초기 조사에서 4532-1234-5678-9012가 발견되었고, 심층 분석 결과 eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9도 함께 탈취된 것으로 나타났습니다. 즉각 삭제 요청을 진행했습니다.",
    "DB 백업 파일 점검 중 보안 취약점이 발견되었습니다. abandon ability able about above가 암호화되지 않은 상태였으며, 추가로 0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb3도 평문으로 저장되어 있었습니다. 즉시 암호화 작업을 완료했습니다.",
    "외부 해킹 시도가 탐지되었습니다. 공격자는 qlalfsento2420!#를 탈취한 것으로 보이며, 후속 조사에서 857도 함께 노출되었음을 확인했습니다. 관련 시스템을 격리했고, IP를 차단했습니다. 복구 작업을 신속히 진행하겠습니다.",
    "고객 계정을 점검한 결과 보안 사고가 발견되었습니다. 사용자명 jh_kim2024가 노출되었고, 심층 분석 중 rt_8Kx9mP2qN5vL7wT3yU6zR4sA1bC0도 함께 유출된 사실을 확인했습니다. 해당 계정을 즉시 비활성화하고 재설정 안내를 발송했습니다.",
    "결제 시스템 로그를 분석한 결과 이상 거래가 포착되었습니다. 초기에 카드번호 5489-3201-7654-0123이 감지되었고, 추가 조사에서 APV-20240315-K-9912도 함께 기록되어 있었습니다. 금융당국에 신고하고 카드 사용을 정지했습니다.",
    "직원 정보 시스템을 점검하던 중 개인정보 유출이 확인되었습니다. BoB-2025-K-6623이 노출되었고, 관련 조사 중 전화번호 010-7788-9900도 함께 발견되었습니다. 개인정보보호법 위반 가능성이 있어 즉시 삭제 조치하고 관련 부서에 경고했습니다.",
    "API 접근 로그를 분석한 결과 비정상적인 패턴이 발견되었습니다. cs_live_9Kx8mP7qN2vL5wT4yU3z가 기록되어 있었고, 추적 결과 이메일 admin@company.co.kr도 함께 노출되었습니다. 무단 접근으로 판단하여 IP를 차단하고 API 키를 재발급했습니다.",
    "백업 서버 점검 중 암호화 누락이 확인되었습니다. pgYNyMz4uxTaV41cLR+ku2EKUnQOzlO6이 평문 상태였고, 같은 파일에서 주소 부산광역시 해운대구 센텀중앙로 48도 발견되었습니다. 암호화 후 접근 권한을 제한했으며, 보안 정책을 강화했습니다.",
    "고객센터 시스템을 점검한 결과 데이터 유출이 확인되었습니다. 티켓번호 TICKET-2024-MAR-9981이 처리 중이었고, 관련 조사에서 주문번호 ORD-2024-W-8832도 함께 노출되었습니다. 내부 시스템 접근 권한을 재설정하고 직원 교육을 실시했습니다.",
    "직원 출입 시스템 로그를 분석한 결과 기록 오류가 발견되었습니다. 사원증 일련번호 SN-EMPL-2024-K-8847이 확인되었고, 함께 근무지 강남사옥 15층도 기록되어 있었습니다. 출입통제 로그 ACCESS-LOG-20240315-9847을 점검한 결과 정상 접근으로 판단됩니다.",
    "해외 송금 거래를 검토한 결과 정상 처리가 확인되었습니다. IBAN 코드 DE89370400440532013000이 사용되었고, 확인 과정에서 SWIFT 코드 COBADEFFXXX도 함께 기록되었습니다. 은행명 Deutsche Bank로 송금이 완료되었으며, 절차상 문제는 없었습니다.",
    "신규 입사자 서류를 검토한 결과 제출이 완료되었습니다. 건강보험증 번호 HI-2024-8837465가 확인되었고, 추가 서류에서 여권번호 M87654321도 함께 제출되었습니다. 모든 서류는 인사팀에서 암호화된 시스템에 안전하게 보관 중입니다.",
    "프로젝트 계약 절차를 진행한 결과 배정이 완료되었습니다. 관리번호 PROJ-2024-Q2-FM-8847이 발급되었고, 담당자에게 직급 책임연구원이 부여되었습니다. 계약금 120,000,000원 입금을 확인했으며, 킥오프 미팅과 내부 시스템 접근 권한 신청도 완료되었습니다.",
    "시스템 로그를 분석한 결과 이상 징후가 발견되었습니다. at_prod_8Hx7nM6pQ1uK4vS3xR2y가 노출되었으며, 해당 계정의 LAST_LOGIN_IP와 SESSION_ID 정보도 함께 기록되어 있었습니다. 보안팀에서 즉시 차단 조치를 취했으며, 전 직원 대상 긴급 보안 교육을 실시할 예정입니다. 추가 조사가 진행 중입니다.",
    "인사팀에서 알려드립니다. 신규 입사자분께서는 KJR-2025-KIA-7821를 부여받으셨고, 업무용 이메일 주소 j.kim@company.co.kr로 계정이 생성되었습니다. PASSWORD 항목은 초기 설정 후 즉시 변경해주시기 바랍니다. 온보딩 일정은 별도 안내드리겠습니다.",
    "고객센터 처리 현황을 알려드립니다. 티켓번호 TICKET-2024-APR-5512 건은 REFUND_ID와 EXCHANGE_ID가 모두 포함된 복합 처리 건으로 분류되었습니다. 담당자 배정이 완료되었으며, 영업일 기준 5일 내 처리 완료 예정입니다. 진행 상황은 실시간으로 업데이트됩니다.",
    "분기별 성과 평가 결과를 공유합니다. 이번 분기 우수 성과자 선정 기준은 PERFORMANCE_GRADE 항목을 최우선으로 고려하였습니다. 해당 기준은 인사위원회에서 승인되었으며, 다음 분기에도 동일하게 적용될 예정입니다. 세부 사항은 인사포털에서 확인 가능합니다.",
    "결제 시스템 점검 완료 보고드립니다. 테스트 과정에서 CARD_NUMBER, CARD_CVV, PAYMENT_PIN 필드의 암호화 상태를 확인했으며, 모든 항목이 정상적으로 보호되고 있음을 확인했습니다. PCI-DSS 규정 준수 여부도 검증 완료되었습니다. 다음 정기 점검은 6개월 후 실시됩니다.",
    "보안팀에서 긴급 점검을 실시했습니다. rt_9Kx8mP2qN5vL7wT3yU6zR4sA1bC0이 외부에 노출된 사실을 확인했으며, 해당 계정의 리프레시 토큰과 액세스 토큰 정보도 함께 유출되었습니다. 즉시 모든 인증 키를 재발급했으며, 보안 강화 조치를 완료했습니다. 추가 피해는 확인되지 않았습니다.",
    "인사 발령 공지드립니다. 신규 배정된 직원분은 EMP-INT-2024-8821이며, 업무용 연락처 010-5566-7788로 등록되었습니다. 사원증 일련번호는 별도 안내 예정이며, 출근 첫날 총무팀에서 수령하시면 됩니다. 환영 간담회는 다음 주 금요일 오후 2시입니다.",
    "결제 내역 조회 결과를 안내드립니다. 주문서 ORD-2024-SPR-9934 건은 배송 추적번호와 송장번호가 모두 발급된 상태입니다. 배송은 내일 출발 예정이며, 실시간 위치 추적이 가능합니다. 수령 후 앱에서 구매 확정 부탁드립니다. 문의사항은 고객센터로 연락주세요.",
    "분기별 인사 평가 기준을 안내드립니다. 올해부터는 성과 등급, 연봉, 복리후생 정보 항목을 종합적으로 반영하여 평가합니다. 해당 기준은 임원진 승인을 받았으며, 모든 부서에 동일하게 적용됩니다. 평가 결과는 다음 달 중순 개별 통보 예정입니다. 세부 사항은 인사포털에서 확인 가능합니다.",
    "시스템 보안 감사를 완료했습니다. 점검 항목은 API 키, OAuth 클라이언트 시크릿, TLS 비공개키 필드의 암호화 수준이었으며, 모든 항목이 보안 기준을 충족했습니다. 취약점 분석 결과도 정상 판정되었습니다. 다음 정기 감사는 6개월 후 실시 예정입니다. 상세 보고서는 보안팀 공유 폴더에 업로드되었습니다.",
    "보안팀에서 긴급 알림드립니다. at_prod_7Hx9nM6pQ1uK4vS3xR2y가 외부에 노출되었으며, 해당 계정의 JPY와 EUR 정보도 함께 유출되었습니다. 즉시 모든 인증 토큰을 재발급했으며, 보안 강화 조치를 완료했습니다. 추가 피해는 확인되지 않았습니다. 전 직원 대상 보안 교육을 실시할 예정입니다.",
    "인사팀에서 공지드립니다. 신규 입사자분은 WHS-1ST-2024-9987이며, 업무용 이메일 주소 hr.kim@company.co.kr로 계정이 생성되었습니다. 급여는 USD로 지급 예정이며, 첫 출근일은 다음 주 월요일입니다. 온보딩 교육은 화요일부터 3일간 진행됩니다. 준비 서류는 인사팀으로 문의해주세요.",
    "결제 시스템 점검 결과를 안내드립니다. 주문번호 ORD-2024-APR-7723 건은 GBP와 CHF 처리가 모두 완료된 상태입니다. 배송은 오늘 오후 출발 예정이며, 실시간 추적이 가능합니다. 수령 후 앱에서 구매 확정 부탁드립니다. 문의사항은 고객센터로 연락주세요.",
    "분기별 재무 보고서를 공유합니다. 이번 분기 결산은 AUD 기준으로 작성되었으며, 모든 항목이 감사를 통과했습니다. 해당 자료는 임원진 승인을 받았으며, 주주총회에서 발표될 예정입니다. 세부 내용은 재무팀 포털에서 확인 가능합니다. 질의사항은 재무팀으로 연락주시기 바랍니다.",
    "해외 송금 시스템 점검을 완료했습니다. 테스트 과정에서 CAD, SGD, HKD 통화의 환율 적용 상태를 확인했으며, 모든 항목이 정상 작동하고 있습니다. SWIFT 연동도 안정적으로 처리되고 있으며, 수수료 계산도 정확합니다. 다음 정기 점검은 6개월 후 실시 예정입니다.",
    "인사발령을 공지드립니다. rt_9Kx7mP4qN1vL5wT2yU8zR6sA3bC0가 시스템에 등록되었으며, 해당 직원에게는 건강검진 지원 확대, 자녀 교육비 보조, 휴가비 추가 지급 및 복지포인트 월 50만원 적립 혜택이 제공됩니다. 상세 내용은 인사팀으로 문의하시기 바랍니다.",
    "보안팀 긴급 공지입니다. cs_prod_7Hx2nM6pQ9uK8vS1xR4y, admin_access_2024_secure, db_connection_live_prod가 동시에 감지되었습니다. 관련 직원들에게는 보안교육 이수 의무화, 특별 근무수당 지급, 재택근무 장비 지원 및 개인정보보호 교육비 전액 지원 혜택이 적용됩니다.",
    "마케팅팀에서 알려드립니다. 신규 프로젝트 담당자 staff_mk_2024_premium이 배정되었으며, 연락처 010-9988-7766으로 업무 연락 가능합니다. 해당 팀원에게는 성과급 별도 지급, 해외연수 기회 제공, 스톡옵션 200주 부여 및 단체보험 가입 혜택이 주어집니다.",
    "분기별 성과 평가 결과를 발표합니다. 우수 성과자 top_performer_Q2_2024에게는 특별 포상이 있으며, 담당 매니저 연락처 02-1234-5678로 상세 안내를 받을 수 있습니다. 또한 premium_grade_level_A 등급을 받은 직원과 부서코드 DEPT-FIN-2024-STAR 소속 전원에게는 승진 가산점 부여, 교육훈련비 지원, 가족 의료비 보조 및 장기근속 포상금 지급 혜택이 제공됩니다.",
    "IT부서 공지사항입니다. 시스템 관리자 계정번호 SYS-ADMIN-2024-7890과 업무용 이메일 주소 system.manager@company.co.kr로 신규 등록되었습니다. 관련 업무 담당자들에게는 야간근무 수당 인상, 기술교육 지원 확대, 개인 노트북 지급 및 통신비 월 15만원 지원 혜택이 적용됩니다.",
    "사내 복지제도 개편안이 최종 승인되었습니다. 올해부터 시행되는 새로운 제도에 따라 모든 직원들에게는 건강검진 지원 확대, 가족 의료비 보조 연간 300만원, 자녀 교육비 지원 및 복지포인트 월 20만원 적립 혜택이 제공됩니다. 세부 내용은 인사포털에서 확인 가능하며, 문의사항은 인사팀으로 연락주시기 바랍니다.",
    "안녕하세요, 직원 여러분. 회사 창립 25주년을 맞아 특별 이벤트를 진행합니다. 장기근속자에게는 해외여행 지원금 200만원, 스마트워치 지급 및 특별유급휴가 5일 추가 혜택이 있으며, 신입사원들에게는 교육훈련비 전액 지원, 멘토링 프로그램 참여 기회 및 웰컴 키트 제공 혜택이 주어집니다. 많은 참여 바랍니다.",
    "분기별 복지 운영 현황을 보고드립니다. 지난 분기 실적을 바탕으로 우수 부서에는 팀 단위 인센티브 지급, 워크숍 비용 지원 및 사무용품 업그레이드 혜택이 제공되며, 개인 성과 우수자에게는 승진 가산점 부여, 개인 연수비 지원 및 프리미엄 건강검진 혜택이 추가됩니다. 해당 부서장님들께서는 상세 안내를 받으시기 바랍니다.",
    "직장 내 교육 프로그램 확대 및 온라인 학습 플랫폼 도입 지원 혜택을 새롭게 시작합니다. 업무 효율성 향상을 위한 다양한 교육 과정이 마련되었으며, 모든 교육비는 회사에서 전액 부담할 예정입니다. 관심 있는 직원분들께서는 교육 담당자에게 신청서를 제출해주시고, 자세한 일정은 다음 주 공지할 예정입니다.",
    "근무 환경 개선을 위한 사무실 리모델링 및 최신 장비 도입 혜택과 재택근무 확대에 따른 홈오피스 구축 지원, 통신비 월 10만원 지원 및 개인 노트북 지급 혜택이 결정되었습니다. 공사 기간 중 임시 사무실이 준비되어 있으니 업무에 차질이 없도록 협조 부탁드리며, 완공 후에는 더욱 쾌적한 환경에서 근무하실 수 있을 것입니다.",
    "요즘 아침에 일찍 일어나는 버릇이 생겼어. 알람 없이도 눈이 떠지는 게 신기하더라. 창문을 열면 시원한 공기가 들어와서 상쾌해. 커피 한 잔 마시며 조용히 하루를 시작하는 게 좋아. 이런 여유가 오래 가면 좋겠어.",
    "어제 오랜만에 영화를 봤어. 웃다가 울다가 감정이 롤러코스터를 탄 것 같았지. 배우들의 연기가 너무 좋아서 몰입이 잘 됐어. 엔딩 크레딧이 올라갈 때까지 자리를 못 떴어. 다음엔 또 다른 영화를 봐야겠어.",
    "주말에 동네를 천천히 걸었어. 평소엔 바빠서 지나쳤던 풍경이 새롭게 보이더라. 작은 골목길의 벽화도 예쁘고, 카페 앞 꽃도 활짝 피어 있었어. 걷다 보니 머리가 맑아지고 마음도 편해졌어. 자주 걸어야겠어.",
    "요즘 책 읽는 재미에 푹 빠졌어. 하루에 한 챕터씩 읽는데 시간 가는 줄 몰라. 주인공의 고민이 공감돼서 더 집중하게 돼. 밤에 읽으면 마음이 차분해지더라. 다 읽고 나면 다른 책도 시작할 거야.",
    "오늘은 집에서 요리를 해봤어. 레시피 보면서 하나하나 따라 했는데 의외로 잘 됐어. 완성된 음식을 맛보니 뿌듯하더라. 간도 딱 맞고 색감도 예쁘게 나왔지. 다음엔 다른 메뉴도 도전해봐야겠어.",
    "점심에 동네 국밥집을 갔는데 국물이 진하고 고기도 푸짐했어. 김치가 아삭아삭해서 입맛을 돋웠지. 주인 아저씨가 친절하게 반찬도 더 주시더라. 따뜻한 국물 한 숟가락에 피로가 싹 풀리는 기분이었어. 다음엔 순대국도 먹어봐야겠어.",
    "저녁에 치킨집에서 후라이드를 시켰는데 바삭함이 정말 최고였어. 양념도 달콤하면서 매콤해서 맥주랑 궁합이 딱이더라. 친구들이랑 수다 떨면서 먹으니 시간 가는 줄 몰랐지. 다음주엔 양념 반 후라이드 반으로 시켜야겠어.",
    "카페에서 아메리카노를 마셨는데 원두 향이 은은하게 퍼지더라. 창밖 풍경을 보면서 여유를 즐기니 힐링되는 기분이었어. 케이크 한 조각도 곁들였는데 달콤함이 적당했지. 조용한 음악이 흘러나와서 집중하기 좋았어. 자주 올 것 같아.",
    "회사 근처 김치찌개집에 갔는데 얼큰한 맛이 일품이었어. 두부도 부드럽고 김치도 잘 익어서 맛있더라. 밥 한 공기를 뚝딱 비웠지. 사장님이 서비스로 계란말이도 주셔서 감동받았어. 점심 단골 될 것 같아.",
    "새로 생긴 베이커리에서 크루아상을 샀는데 겉은 바삭하고 속은 촉촉했어. 버터 향이 풍부해서 한입 베어 물 때마다 행복했지. 커피랑 같이 먹으니 완벽한 조합이더라. 빵 종류가 다양해서 다음엔 다른 것도 맛봐야겠어.",
    "-----BEGIN RSA PRIVATE KEY----- MIIEpAIBAAKCAQEA1x8y... -----END RSA PRIVATE KEY-----를 서버에 배포했으며, 추가 보안을 위해 -----BEGIN CERTIFICATE----- MIIDXTCCAkWgAwIBAgIJAP... -----END CERTIFICATE-----도 함께 설정했습니다. 암호화 통신 준비가 완료되었습니다.",
    "AKIA4EXAMPLE9KEY12XYZ를 24시간 한시적으로 사용 중이며, 접속 기록 분석 결과 FP-Safari-MacOS-7Hx4nQ2pM9로 확인되었습니다. 임시 인증 정보는 자동으로 만료될 예정입니다.",
    "인증 시스템 업그레이드를 진행한 결과 설정이 완료되었습니다. JBSWY3DPEHPK3PXZ가 발급되었고, 9Y8Z-B2C3-D4E5-F6G7도 안전하게 생성되었습니다. 사용자는 30일 이내 재인증이 필요합니다.",
    "saml-response-2024-a9b8c7와 oidc-token-eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9를 통한 SSO 연동이 성공적으로 완료되었습니다. 다중 시스템 접근이 가능하며, 세션 만료 시간은 8시간으로 설정되었습니다.",
    "데이터베이스 접속 정보를 업데이트했습니다. postgresql://user:Pass!2024@db.internal.net:5432/production과 https://admin.internal.company.net를 새로 등록했습니다.",
    "사용자 이정민의 계정 정보를 확인한 결과 정상 로그인이 확인되었으며, auth_session=xyz789abc456; Secure; HttpOnly도 유효한 상태입니다. 접근 권한 검증이 완료되었습니다.",
    "커뮤니티 닉네임 '하늘을나는새'로 등록된 사용자가 at_live_7Kx9mN2pQ5vL8wT4yU6를 통해 API 호출을 시도했습니다. 요청이 정상 처리되었으며, 로그에 기록되었습니다.",
    "고객 문의 처리 중 계약 정보를 확인했습니다. 회사명 삼성디지털솔루션 주식회사의 CUST-2024-K-7789가 조회되었고, 관련 주문 이력도 함께 검토했습니다. 처리가 신속히 완료되었습니다.",
    "구매자명 최수진과 HANJIN-KR-20240316-5678을 확인한 결과 상품이 정상 배송 중입니다. 예상 도착일은 내일 오후이며, 실시간 위치 추적이 가능합니다.",
    "본인 인증 절차를 진행한 결과 문제없이 완료되었습니다. 850325-1234567과 생년월일 1985년 3월 25일이 일치하여 승인되었습니다.",
    "부서 마케팅전략팀 소속 직원의 근무형태 정규직을 검토한 결과 확인되었으며, 인사 기록이 정상적으로 관리되고 있습니다. 추가 조치는 필요하지 않습니다.",
    "입사일자 2024년 3월 1일로 등록된 신입사원의 연봉 45,000,000원을 확인한 결과 책정되었습니다. 급여 지급은 매월 25일에 이루어집니다.",
    "급여 입금 처리를 진행한 결과 정상 완료되었습니다. 계좌번호 110-456-789012와 지점명 강남지점이 확인되었고, 오늘 오후 3시 이전 입금 예정입니다. 수령 후 확인 부탁드립니다.",
    "회원등급 골드와 쿠폰코드 SUMMER2024-20OFF를 적용한 결과 최종 금액이 산출되었습니다. 추가 혜택도 자동으로 적용되었으며, 결제 진행이 가능합니다.",
    "세금계산서 처리를 완료했습니다. 송장번호 INV-2024-Q1-5678과 환불번호 REFUND-2024-APR-1234가 시스템에 등록되었습니다.",
    "데이터베이스 백업 파일 점검 중 보안 이슈가 발견되었습니다. mongodb://admin:P@ssDB2024@prod-cluster.internal:27017/maindb가 평문으로 저장되어 있었으며, 해당 서버의 CONNECTION_STRING과 INTERNAL_URL 정보도 함께 노출되어 있었습니다. 즉시 암호화 조치를 완료했으며, 접근 권한을 재설정했습니다. 보안 감사 보고서를 작성 중입니다.",
    "급여 정산 안내드립니다. 이번 달은 85,500,000원으로 확정되었으며, 입금 계좌 KB국민은행 123-456789-012로 25일 입금 예정입니다. SALARY 항목은 세전 금액이며, 원천징수 내역은 별도 확인 가능합니다. 급여명세서는 인사포털에서 다운로드하실 수 있습니다.",
    "회원 정보 업데이트를 완료했습니다. 닉네임 행복한여행자99로 변경되었으며, MEMBERSHIP_ID와 CUSTOMER_ID 필드가 새로 생성되었습니다. 포인트 적립 혜택이 자동 적용되며, 등급 업그레이드 심사가 진행됩니다. 변경 내역은 이메일로 발송되었으니 확인해주시기 바랍니다.",
    "분기별 복리후생 제도 개편 안내드립니다. 신규 도입되는 항목은 BENEFIT_INFO 카테고리에 포함되며, 전 직원에게 동일하게 적용됩니다. 세부 내용은 인사위원회 승인 후 공지될 예정이며, 적용 시점은 다음 달 1일부터입니다. 문의사항은 인사팀으로 연락주시기 바랍니다.",
    "시스템 보안 점검 결과를 보고드립니다. 테스트 환경에서 API_KEY, OAUTH_CLIENT_SECRET, SSH_PRIVATE_KEY 필드의 암호화 수준을 검증했으며, 모든 항목이 AES-256 기준을 충족하고 있음을 확인했습니다. 취약점 스캔 결과도 이상 없이 통과했습니다. 다음 점검은 분기말에 실시됩니다.",
    "야, 너 어제 그거 봤어? 시스템에서 JBSWY3DPEHPK3PXP 이상하게 떴다가 사라졌거든. 나중에 확인해보니까 다단계 인증 시크릿이랑 복구용 백업코드도 같이 기록되어 있더라고. 완전 이상한 거 아니야? 보안팀한테 바로 얘기했는데 지금 조사 중이래. 걱정되네 진짜.",
    "[속보] 대형 유통업체 개인정보 유출 사건 발생. 경찰 관계자에 따르면 해커가 cs_live_9Kx8mP7qN2vL5wT4yU3z를 탈취한 것으로 확인됐으며, 피해 고객의 은행 지점명 우리은행 강남지점 계좌 정보도 함께 노출됐다. 통화 단위는 전액 원화로 처리됐으며, 금융당국이 긴급 대응에 나섰다. 추가 피해 방지를 위한 조치가 진행 중이다.",
    "피의자 A씨는 범행 당시 사용한 휴대폰에서 닉네임 해커왕2024를 사용했으며, 조사 과정에서 피해자의 고객 식별번호와 회원등급 정보가 저장된 파일이 발견됐다. 검찰은 A씨가 해당 정보를 불법 거래 사이트에서 구매한 것으로 보고 있으며, 공범 여부를 추가 수사 중이다. A씨는 혐의를 전면 부인하고 있다.",
    "의장: 오늘 안건은 신규 복지 제도 도입 건입니다. 먼저 인사팀 보고 들어보시죠. 인사팀장: 네, 이번에 도입하려는 건 복리후생 정보 통합 관리 시스템입니다. 기존에는 각 부서별로 따로 관리했는데요, 이제 한 곳에서 확인 가능합니다. 재무팀장: 예산은 어느 정도 책정되나요? 인사팀장: 초기 구축비로 약 5천만 원 예상하고 있습니다.",
    "현대 사회에서 개인정보 보호는 더 이상 선택이 아닌 필수가 되었다. 특히 인증 시크릿 키, 세션 토큰, 쿠키 값과 같은 민감 데이터는 한 번 유출되면 회복이 불가능하다. 기업들은 암호화 기술에 막대한 투자를 하고 있지만, 인적 오류로 인한 유출 사고는 여전히 빈번하다. 따라서 기술적 보안 강화와 더불어 직원 교육이 병행되어야 한다.",
    "보고서 제출합니다. 제2분기 매출 실적을 분석한 결과, mongodb://user:Pass@finance-db.internal:27017/ledger 시스템에서 이상 징후가 포착되었습니다. 해당 데이터베이스의 연결 문자열과 NOK 설정이 비정상적으로 변경되어 있었습니다. 즉시 복구 작업을 진행했으며, 백업 시스템으로 전환했습니다. 추가 조사가 필요한 상황입니다.",
    "A: 어제 회계팀에서 뭔가 이상하다고 했잖아? B: 아, 맞아! rt_8Kx9mP2qN5vL7wT3yU6zR4sA1bC0 문제였어. A: 그거 닉네임 금융왕777로 추적 가능하지 않아? B: 맞아, 그리고 PLN으로 계산하면 얼마나 되는 거야? A: 바로 보고해야겠다. B: 응, 재무팀장님께 말씀드리자.",
    "범죄 수사 기록부에 따르면, 피의자는 온라인 거래 시 닉네임 머니킹777을 사용했습니다. 압수수색 과정에서 피해자의 DKK와 SEK 거래 내역이 발견되었으며, 총 피해 규모는 북유럽 통화 기준으로 상당한 수준인 것으로 파악됩니다. 검찰은 국제 금융 범죄 전담팀과 합동 수사를 진행 중입니다.",
    "안녕하세요, 고객님. 결제 오류에 대해 안내드립니다. 고객님께서 선택하신 결제가 시스템 오류로 다른 통화로 표시되는 현상이 발생했습니다. 현재 기술팀에서 MXN 설정을 수정 작업 중이며, 올바른 금액으로 재청구 예정입니다. 불편을 드려 죄송합니다. 추가 문의사항은 언제든 연락주세요.",
    "디지털 경제 시대에서 암호화폐와 전통 화폐의 경계는 점점 모호해지고 있다. 특히 TWD, MYR, INR 같은 아시아 통화들은 블록체인 기술과의 융합을 통해 새로운 금융 생태계를 구축하고 있다. 이러한 변화는 기존 중앙은행 체제에 근본적인 도전을 제기하며, 글로벌 통화 정책에도 중대한 영향을 미치고 있다.",
    "야, 너 들었어? 어제 시스템에서 oauth_secret_key_2024_live랑 session_prod_8Kx9mP2q가 동시에 떴다더라. 그래서 회사에서 우리한테 특별휴가 3일 추가, 식대 월 30만원 인상, 헬스장 이용권 제공하고 스마트워치까지 지급해준다는 거야. 완전 대박이지?",
    "범죄수사기록부 작성 중입니다. 피의자가 사용한 crypto_wallet_addr_9Kx7mP4q와 financial_token_2024_hack이 압수물에서 발견되었습니다. 수사관들에게는 특수수당 지급, 야간근무비 인상, 전문교육 이수 지원 및 위험수당 월 50만원 추가 지급이 결정되었습니다.",
    "[속보] 대기업 해킹 사건 수사 진전. 경찰 관계자에 따르면 해커가 사용한 malware_signature_x7y8z9가 특정되었으며, 피해 기업 대표번호 1588-9999로 추가 신고가 접수되고 있습니다. 수사팀에게는 성과급 특별 지급, 해외연수 기회 제공, 전담팀 구성 지원 및 특별진급 심사 기회가 부여됩니다.",
    "회의록: 보안 강화 방안 논의. 의장이 언급한 security_protocol_2024_new와 담당자 휴대폰 010-5577-8899는 기밀 유지가 필요하며, advanced_encryption_key_live 시스템과 부서 내선번호 02-9876-5432도 마찬가지입니다. 참석자들에게는 보안교육 이수 시 상여금 지급, 기밀유지 수당 월 25만원, 보안장비 개인 지급 및 특별승진 가점 부여가 약속되었습니다.",
    "고객센터 운영 현황 보고드립니다. 고객 문의 전화번호 1577-1234와 담당자 이메일 주소 support.team@company.co.kr로 접수된 건들을 처리 중입니다. 상담원들에게는 친절서비스 우수자 포상금 지급, 스트레스 관리 프로그램 제공, 개인 휴게공간 마련 및 성과급 인상 혜택이 새롭게 도입됩니다.",
    "A: 회사에서 새로운 복지 제도 도입한다던데? B: 맞아, 스트레스 관리 프로그램 도입 및 심리상담 지원 확대 혜택이랑 운동시설 이용료 지원, 마사지 서비스 월 2회 제공 및 건강기능식품 지급 혜택까지 생겼어. A: 진짜? 그럼 우리도 신청할 수 있는 거야? B: 당연하지! 다음 주부터 신청 받는다더라.",
    "이번 달부터 시행되는 육아휴직 확대 및 출산장려금 인상 혜택에 대해 안내드립니다. 기존 제도에서 더욱 개선된 내용으로, 모든 직원이 혜택을 받을 수 있도록 확대되었습니다. 관련 서류는 총무팀에 비치되어 있으며, 신청 절차는 매우 간단하니 필요하신 분들은 언제든 문의해주시기 바랍니다.",
    "[긴급] 코로나19 대응 방안 발표. 정부 지침에 따라 재택근무가 확대 시행되며, 직원들의 안전과 건강을 위해 방역용품 개인 지급 및 PCR 검사비 전액 지원 혜택과 격리기간 중 특별유급휴가 제공, 건강관리비 월 15만원 지원 및 면역력 강화 프로그램 참여 혜택이 새롭게 마련되었습니다. 모든 직원은 안전 수칙을 준수해주시기 바랍니다.",
    "회사 사보 편집팀에서 알려드립니다. 매월 발행되는 사내 소식지 제작에 많은 관심과 참여 부탁드리며, 우수 기고자에게는 문화상품권 지급 및 사내 포상 수여 혜택을 제공하고 있습니다. 원고 마감일은 매월 20일이며, 채택된 글에 대해서는 소정의 원고료도 지급됩니다. 많은 참여와 관심 부탁드립니다.",
    "환경보호 캠페인 참여 독려 및 친환경 사무용품 도입 지원 혜택과 대중교통 이용 장려를 위한 교통비 추가 지원, 자전거 출퇴근자 인센티브 및 전기차 구매 보조금 지급 혜택을 새롭게 시작합니다. 지구를 지키는 작은 실천이 회사와 개인 모두에게 도움이 되는 만큼, 적극적인 참여를 부탁드리며 관련 안내는 환경팀에서 별도 공지할 예정입니다.",
    "최근에 그림 그리기를 시작했어. 처음엔 서툴렀는데 연습하니까 조금씩 나아지더라. 색칠하면서 집중하다 보면 스트레스가 풀려. 완성된 그림을 보면 성취감이 느껴져. 취미로 계속 이어갈 생각이야.",
    "어제 친구랑 전화로 한참 수다를 떨었어. 몇 시간이 훌쩍 지나갔는데 전혀 지루하지 않았어. 서로의 근황도 나누고 고민도 털어놨지. 웃다가 진지해지기도 하고 그런 시간이 소중하게 느껴졌어. 자주 연락해야겠어.",
    "요즘 식물 키우는 재미에 빠졌어. 매일 아침 물 주면서 성장하는 모습을 보는 게 좋아. 작은 잎이 돋아나면 괜히 뿌듯하더라. 햇빛 잘 드는 곳에 두니까 더 잘 자라는 것 같아. 계속 잘 키워야지.",
    "오늘은 일기를 썼어. 하루를 돌아보면서 적다 보니 생각이 정리되더라. 기쁜 일도 있었고 힘든 일도 있었지만 다 의미 있게 느껴졌어. 글로 쓰니까 감정이 더 선명해지는 것 같아. 꾸준히 써봐야겠어.",
    "주말에 혼자 카페에 갔어. 조용히 앉아서 음악 들으며 시간을 보냈지. 사람들 구경하면서 멍 때리는 게 생각보다 힐링됐어. 커피 향이 퍼지는 공간이 편안하더라. 다음 주말에도 또 올 것 같아.",
    "아침에 토스트를 만들어 먹었는데 계란이 부드럽게 익어서 맛있었어. 치즈가 녹아내리면서 고소한 향이 퍼졌지. 간단하지만 포만감이 좋아서 만족스러웠어. 커피 한 잔과 함께하니 완벽한 아침이었어. 내일도 만들어야겠어.",
    "점심에 떡볶이를 먹었는데 매콤달콤한 맛이 정말 좋았어. 어묵이랑 튀김도 바삭해서 식감이 좋더라. 국물까지 다 먹으니 배가 든든했지. 길거리 음식 특유의 매력이 있어서 자꾸 생각나. 다음엔 친구랑 같이 먹어야겠어.",
    "저녁에 삼겹살을 구워 먹었는데 기름기가 적당하고 고소했어. 상추에 쌈장 듬뿍 발라 먹으니 환상이더라. 된장찌개도 얼큰해서 입맛을 돋웠지. 고기 굽는 냄새가 식욕을 자극했어. 주말엔 또 가야겠어.",
    "카페에서 녹차라떼를 마셨는데 은은한 향이 좋았어. 달지 않아서 부담 없이 마실 수 있더라. 쿠키도 바삭해서 궁합이 잘 맞았지. 조용한 분위기에서 책 읽기 딱 좋았어. 자주 찾게 될 것 같아.",
    "동네 칼국수집에서 점심을 먹었는데 면발이 쫄깃하고 국물이 시원했어. 김치도 잘 익어서 맛있더라. 양도 푸짐해서 배불리 먹었지. 주인 할머니가 친절하게 반찬도 더 주셨어. 단골이 될 것 같아."
]

def infer_once(tok, model, prompt: str, max_new_tokens: int = 256) -> Dict[str, Any]:
    messages = [
        {"role": "system", "content": SYS_PROMPT},
        {"role": "user", "content": prompt}
    ]
    inputs = tok.apply_chat_template(messages, return_tensors="pt", add_generation_prompt=True)
    inputs = inputs.to(model.device)

    streamer = TextIteratorStreamer(tok, skip_special_tokens=True, decode_kwargs={"skip_special_tokens": True})
    gen_kwargs = dict(
        inputs=inputs,
        max_new_tokens=max_new_tokens,
        do_sample=False,
        eos_token_id=tok.eos_token_id,
        streamer=streamer,
    )

    # run generate on a background thread to use the streamer
    first_token_time: Optional[float] = None
    raw_chunks = []
    start = time.perf_counter()

    def _consume():
        nonlocal first_token_time
        for i, token_text in enumerate(streamer):
            if first_token_time is None:
                first_token_time = time.perf_counter()
            raw_chunks.append(token_text)

    t = threading.Thread(target=_consume)
    t.start()

    with torch.no_grad():
        model.generate(**gen_kwargs)

    t.join()
    end = time.perf_counter()

    raw_out = "".join(raw_chunks).strip()
    total_ms = (end - start) * 1000.0
    ttft_ms = (first_token_time - start) * 1000.0 if first_token_time else None

    # token/s 계산 (생성 토큰 기준)
    # 입력/출력 토큰 길이 측정
    out_ids = tok(raw_out, return_tensors="pt")["input_ids"][0]
    gen_tokens = out_ids.size(0)
    tok_s = None
    if first_token_time:
        duration_gen = end - first_token_time
        if duration_gen > 0:
            tok_s = gen_tokens / duration_gen

    # JSON 파싱 시도
    parsed = None
    try:
        # 모델이 앞말 덧붙였을 수 있으니 중괄호 첫/끝 구간만 salvage
        s = raw_out
        l = s.find("{")
        r = s.rfind("}")
        if l != -1 and r != -1 and r > l:
            parsed = json.loads(s[l:r+1])
        else:
            parsed = json.loads(s)  # 혹시 순수 JSON이면
    except Exception:
        parsed = None

    return {
        "raw": raw_out,
        "json": parsed,
        "ttft_ms": ttft_ms,
        "total_ms": total_ms,
        "tok_s": tok_s
    }

def main():
    ap = argparse.ArgumentParser()
    ap.add_argument("--model_dir", required=True, help="Merged model dir (e.g., runs/qwen7b_sft_merged)")
    ap.add_argument("--max_new_tokens", type=int, default=256)
    ap.add_argument("--limit", type=int, default=0, help="테스트할 프롬프트 개수 제한(0=전체)")
    args = ap.parse_args()

    tok = AutoTokenizer.from_pretrained(args.model_dir, use_fast=True)
    model = AutoModelForCausalLM.from_pretrained(args.model_dir, device_map="auto", torch_dtype="auto")
    if tok.pad_token is None:
        tok.pad_token = tok.eos_token

    prompts = DEFAULT_PROMPTS[: args.limit or None]

    for i, p in enumerate(prompts, 1):
        r = infer_once(tok, model, p, max_new_tokens=args.max_new_tokens)
        print(f"\n--- TEST #{i} ---")
        print("prompt:", p)
        print(
            "ttft_ms:", f"{r['ttft_ms']:.2f}" if r['ttft_ms'] else "NA",
            "| tok/s:", f"{r['tok_s']:.2f}" if r['tok_s'] else "NA",
            "| total_ms:", f"{r['total_ms']:.2f}"
        )
        print("output:", r["raw"])
        print("parsed_json:", json.dumps(r["json"], ensure_ascii=False) if r["json"] is not None else "None")

if __name__ == "__main__":
    main()
